# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/kubernetes.conf.erb
<match fluent.**>
  type null
</match>

<source>
  type tail
  path /var/log/containers/wp-cache*.log
  pos_file /var/log/fluentd-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  tag kubernetes.*
  format json
  read_from_head true
</source>

<filter kubernetes.**>
  type kubernetes_metadata
</filter>

<filter kubernetes.**>
  type record_transformer
  enable_ruby true
  auto_typecast true
  <record>
   brand_id "#{ENV['LOG_ENVELOPE_BRANDID'] || nil}" 
   data: ${{"container_name" => kubernetes["container_name"], "pod_namespace" => kubernetes["namespace_name"], "pod_name" => kubernetes["pod_name"], "pod_uid"=> attrs["io.kubernetes.pod.uid"], "siteid" => kubernetes["pod_name"].gsub(kubernetes["container_name"] + "-", "").gsub(/-[^-]*\z/,""),  "message" => record["log"]}}
   datacenter "#{ENV['LOG_ENVELOPE_DATACENTER']}"
   envelope_version "1.2.1"
   environment "#{ENV['LOG_ENVELOPE_ENVIRONMENT']}"
   host "#{ENV['LOG_ENVELOPE_HOST']}"
   request_id "#{ENV['LOG_ENVELOPE_REQUESTID'] || nil}"
   role "#{ENV['LOG_ENVELOPE_ROLE']}"
   session_id "#{ENV['LOG_ENVELOPE_SESSIONID'] || nil}"
   severity
   sub_type
   timestamp ${record["time"]}
   type
  </record> 
  remove_keys log,attrs,stream,kubernetes,docker,time
</filter>

