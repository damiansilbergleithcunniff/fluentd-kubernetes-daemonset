# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/kubernetes.conf.erb
<match fluent.**>
  type null
</match>

<source>
  type tail
  path "#{ENV['LOG_SOURCE_PATH']}"
  pos_file /var/log/fluentd-containers.log.pos
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  keep_time_key true
  tag kubernetes.*
  format json
  read_from_head true
</source>

<filter kubernetes.**>
  type kubernetes_metadata
</filter>


<filter kubernetes.**>
  type record_transformer
  enable_ruby true
  auto_typecast true
  <record>
   brand_id ${"#{ENV['LOG_ENVELOPE_BRANDID']}" != "" ? "#{ENV['LOG_ENVELOPE_BRANDID']}" : nil}
   data: ${{"container_name" => kubernetes["container_name"], "pod_namespace" => kubernetes["namespace_name"], "pod_name" => kubernetes["pod_name"], "pod_uid"=> attrs["io.kubernetes.pod.uid"], "siteid" => kubernetes["pod_name"].gsub(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/,'\1'), "message" => record["log"]}}
   datacenter "#{ENV['LOG_ENVELOPE_DATACENTER']}"
   envelope_version "1.2.1"
   environment "#{ENV['LOG_ENVELOPE_ENVIRONMENT']}"
   host ${{"hostname" => "#{ENV['LOG_ENVELOPE_HOST']}"}}
   role ${"#{ENV['LOG_ENVELOPE_ROLE']}" != "" ? "#{ENV['LOG_ENVELOPE_ROLE']}" : "BUSINESS_ANALYTICS"}
   timestamp ${record["time"]}
   type ${"#{ENV['LOG_ENVELOPE_TYPE']}" != "" ? "#{ENV['LOG_ENVELOPE_TYPE']}" : "mwp2-kubernetes-accesslogs"}
  </record>
  remove_keys log,attrs,stream,kubernetes,docker,time
</filter>
